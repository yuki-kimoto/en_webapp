<h2>会員登録フォームのバリデーション</h2>

会員登録フォームのバリデーションの処理を書いていきましょう。バリデーションとは、ユーザーから入力されたデータが正しいものであるかを検証する作業のことをいいます。

<h3>送信されたユーザー情報を取得する</h3>

送信されたユーザー情報は、パラメーターから取得します。ユーザー情報が入ったパラメーターを取得するには<a href="https://tutorial.perlzemi.com/blog/20110501130707.html">paramメソッド</a>を使用します。

<a href="/blog/20200107082558.html">会員登録フォーム</a>からPOSTされた情報を受け取ってみましょう。この処理では、POSTであって、仮登録の処理であるかを、事前に確認しています。

<pre>
<%
  # POSTリクエストの処理
  if ($self->method eq 'POST') {
    # 処理方法
    my $op = param('op');
    $op = '' unless defined $op;
    
    # 仮登録の処理
    if ($op eq 'register') {
      # ユーザー情報の取得
      # ユーザーID
      my $code = param('code');
      
      # パスワード
      my $password = param('password');
      
      # メールアドレス
      my $mail = param('mail');
    }
  }
%>
</pre>

<h3>ユーザーIDのバリデーション</h3>

ユーザーIDが正しいものであることを確認しましょう。ユーザーIDが正しいというのは、Mojoliciousスタートアップでは次のように定義します。

<ul>
  <li>ユーザーIDが指定されていること</li>
  <li>ユーザーIDが、ASCIIコードの英数字とアンダーバーの1文字以上で構成されていること</li>
  <li>ユーザーIDの長さがサービスで利用できるユーザーIDの長さの制限内であること</li>
  <li>ユーザーIDが、存在するユーザーのユーザーIDと重複しないこと</li>
  <li>ユーザーIDが、異なるメールアドレスのユーザー認証待ちのユーザーのユーザーIDと重複しないこと</li>
</ul>

ユーザーIDは、一意でなければならないので、これをチェックするために、データベースにアクセスする必要があることに注意しましょう。

ユーザーIDのバリデーションを書いていきましょう。正しくない場合は、エラー情報に追加するようにしています。

<h4>ユーザーIDが指定されていること</h4>

まず最初に、ユーザーIDが空ではないことを確認しましょう。エラーは、$errorsという<a href="https://tutorial.perlzemi.com/blog/20180208151809.html">ハッシュのリファレンス</a>に保存しておきます。文字列の長さは、<a href="https://tutorial.perlzemi.com/blog/20080926122245.html">length関数</a>で取得できます。

<pre>
my $errors = {};
if (length $user_code > 0) {
  
}
else {
  # エラー処理
  $errors->{user_code} = 'ユーザーIDを指定してください。';
}

</pre>

<h4>ユーザーIDが、ASCIIコードの英数字とアンダーバーの1文字以上で構成</h4>

ユーザーIDが、ASCIIコードの英数字とアンダーバーの1文字(a-zA-Z0-9_)以上で構成されていることをチェックするには、Perlの正規表現を使いましょう。

<a href="https://tutorial.perlzemi.com/blog/20100827127859.html">正規表現</a>は以下の二つのどちらかで表現できます。素直に<a href="https://tutorial.perlzemi.com/blog/20200114103559.html">文字クラス</a>で書くか、PerlのASCIIコードで構成されたワード文字を表現する文字クラスを使います。

<pre>
# 文字クラスで素直に書く
^[a-zA-Z0-9_]+$

# PerlのASCIIコードで構成されたワード文字を表現する文字クラスを使う
^\p{PosixWord}+$
</pre>

Perlのコードで書いてみます。

<pre>

# Perlのワード文字(a-zA-Z0-9_)
if ($user_code =~ /^\p{PosixWord}+$/) {
  
}
else {
  # エラー処理
  $errors->{user_code} = 'ユーザーIDに利用できる文字は「a-zA-Z0-9_」です。';
}
</pre>

<h4>ユーザーIDの長さがサービスで利用できるユーザーIDの長さの制限内であること</h4>

ユーザーIDの長さがサービスで利用できるユーザーIDの長さの制限内であることをチェックしましょう。

グローバルに利用されている、Twitterというサービスでは、ユーザーIDは15文字以内となっています。

Mojoliciousスタートアップでは、これを参考にして、ユーザーIDの長さの制限は、15文字以内にします。文字列の長さは、<a href="https://tutorial.perlzemi.com/blog/20080926122245.html">length関数</a>で取得できます。

<pre>
# ユーザー名の長さの制限 15文字
if (length $user_code <= 15) {
  
}
else {
  # エラー処理
  $errors->{user_code} = 'ユーザーIDに利用できる文字の長さは15文字以内です。';
}
</pre>

(執筆中)
